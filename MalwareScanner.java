import java.io.*;
import java.util.Map;

/**
 * This class accomplishes Mission Firewall
 */
public class MalwareScanner {

    private final Map<String, Malware> malwareDB;

    public MalwareScanner(Map<String, Malware> malwareDB) {
        this.malwareDB = malwareDB;
    }

    /**
     * TODO: Open and read the input file while searching for threats
     * TODO: Write results to both; a new file name "scanLog.txt" and to the console
     *
     * @param filename the input file
     * @throws IOException the io exception
     */
    public void scanFile(String filename) {


        try {
            BufferedReader br = null;
            File file = new File(filename);
            br = new BufferedReader(new FileReader(file));

        String message="";
        String inMessage ="Started scanning...\n"+"--------------------------------------------------------------------------------\n";
        System.out.print(inMessage);

        int malwareCount=0;

        String str;
        int counter= 0;
        while ((str = br.readLine()) != null) {

            counter++;
            String hash = turbo64(str);

            if(malwareDB.containsKey(hash)){

                message += hash+"@"+counter+"\n";
                malwareCount++;

                String newMessage= "Detected malware!\n" +
                        "Name: " +malwareDB.get(hash).getTitle()+"\n"+
                        "Threat Level: " +malwareDB.get(hash).getLevel()+"\n"+
                        "Hash:"+hash+"\n"
                        +"--------------------------------------------------------------------------------\n";
                System.out.print(newMessage);

            }

        }
        String outMessage  ="Scan complete! "+malwareCount+" threats are found and eliminated. Generating log file...\n";
        System.out.print(outMessage);
        message= message.trim();
        write(message);//create scanLog.txt
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static String turbo64(String in) {

        try{

            long modTurbo = 4294967291L;
            long a = 0;
            long b = 1;

            for(int c = 0 ; c< in.length();c++){

                char ch = in.charAt(c);
                a = (a+ch)%modTurbo;
                b = (a+b)%modTurbo;

            }
            return Long.toHexString((b<<32) | a );
        }catch (Exception e ){
            e.printStackTrace();
        }
        return null;
    }
    public void write(String message){

        try {

            String fileName = "scanLog.txt";
            FileWriter file = new FileWriter(fileName);

            BufferedWriter output = new BufferedWriter(file);

            output.write(message);

            output.close();
        }

        catch (Exception e) {
            e.getStackTrace();
        }

    }
}
